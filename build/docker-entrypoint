#!/bin/bash
# ==============================================================================
# Agentbox Docker Entrypoint
# Runs firewall setup, then executes agent
# ==============================================================================

set -e

WORKSPACE="/workspace"
CODEX_CALLBACK_PORT="1455"
CODEX_RELAY_PORT="2455"
RELAY_PID=""

cleanup_relay() {
    if [[ -n "$RELAY_PID" ]]; then
        kill "$RELAY_PID" >/dev/null 2>&1 || true
    fi
}

start_codex_callback_relay() {
    if ! command -v socat >/dev/null 2>&1; then
        echo "[WARN] socat not found; Codex OAuth callback relay disabled" >&2
        return 0
    fi

    # Relay container-reachable traffic on 2455 to Codex's localhost callback on 1455.
    socat "TCP-LISTEN:${CODEX_RELAY_PORT},bind=0.0.0.0,reuseaddr,fork" "TCP:127.0.0.1:${CODEX_CALLBACK_PORT}" >/tmp/codex-oauth-relay.log 2>&1 &
    RELAY_PID="$!"
}

# ============================================================================
# AGENT DETECTION
# ============================================================================

AGENT="${AGENTBOX_AGENT:-}"

if [[ -z "$AGENT" ]]; then
    if command -v claude >/dev/null 2>&1; then
        AGENT="claude"
    elif command -v codex >/dev/null 2>&1; then
        AGENT="codex"
    elif command -v opencode >/dev/null 2>&1; then
        AGENT="opencode"
    fi
fi

if [[ -n "$AGENT" ]] && ! command -v "$AGENT" >/dev/null 2>&1; then
    echo "[ERROR] Agent '$AGENT' not found on PATH. The install likely failed during image build." >&2
    echo "[ERROR] Rebuild the agent image and check installer output." >&2
    exit 127
fi

# ============================================================================
# RUN AGENT
# ============================================================================

cd "$WORKSPACE"

# Debug: show what's available
if [[ "${VERBOSE:-false}" == "true" ]]; then
    echo "[DEBUG] PATH=$PATH" >&2
    echo "[DEBUG] HOME=$HOME" >&2
    echo "[DEBUG] AGENT=$AGENT" >&2
    ls -la /home/user/.local/bin/ >&2 2>/dev/null || echo "[DEBUG] .local/bin not found" >&2
    which claude >&2 2>/dev/null || echo "[DEBUG] claude not in PATH" >&2
fi

if [[ "$AGENT" == "codex" ]]; then
    start_codex_callback_relay
    trap cleanup_relay EXIT INT TERM
fi

if [[ $# -gt 0 ]]; then
    case "$1" in
        claude|codex|opencode)
            exec "$@"
            ;;
        *)
            if [[ -n "$AGENT" ]]; then
                exec "$AGENT" "$@"
            else
                exec "$@"
            fi
            ;;
    esac
else
    if [[ -n "$AGENT" ]]; then
        exec "$AGENT"
    else
        exec bash
    fi
fi
